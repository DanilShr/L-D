# Логирование в django

Для логирования лучше всего подходить фрeимворк logging. Для использования логирования в приложении django необходимо 
указать в настройках. 
```python
LOGGING = {
    'version': 1,
    'disable_existing_loggers': False, #настройка, которая не отключает существующие логеры 
    'handler': { #команда, которая будет выводить в консоль
        'console': {
            'class': 'logging.StreamHandler',
        },
    },
    'root': { #корневая настройка логера с указанием команд и уровнем
        'handlers': ['console'],
        'level': 'INFO',
    },
}
```
Для использования логера в файлах приложения его можно проинициализировать следующим образом
```python
logger = logging.getLogger(__name__)
```

## Форматирование логов
Настройка форматирования включает в себя настройку представления логов и включения его в самих настройках 
```python
LOGGING = {
    'version': 1,
    'disable_existing_loggers': False,
    'formatters': {
        'verbose': {
            'format': '[%(levelname)s] %(asctime)s %(message)s'
        }
    },
    'handlers': {
        'console': {
            'class': 'logging.StreamHandler',
            'formatter': 'verbose',
        },
    },
    'root': {
        'handlers': ['console'],
        'level': 'INFO',
    },
}
```
* %(levelname)s - Указывает имя level;
* %(asctime)s - указывает время;
* %(message)s - показывает сообщение которое, передается в логах;

## Ротация логов
Ротация логов хорошая практика позволяющая не хранить старые и ненужные логи путем удаления их в соответствии с заданными 
правилами хранения:
* Удаление по размеру файла;
* Удаление логово по истечению времени;

Пример настройки ротации логов по размеру файла:
```python
LOGFILE_NAME = BASE_DIR / 'log.txt'
LOGFILE_SIZE = 400
LOGFILE_COUNT = 3



        'logfile': {
            'class': 'logging.handlers.RotatingFileHandler',
            'filename': LOGFILE_NAME,
            'maxBytes': LOGFILE_SIZE,
            'backupCount': LOGFILE_COUNT,
            'formatter': 'verbose',
        }
```

## Профилирование 
Профилирование - это процесс анализа производительности кода для выявления узких мест и дальнейшей оптимизации приложений

Для подключения профилирования к приложению необходимо установить пакет 
```python
pip install django-debug-toolbar
```
После установки требуется указать настройки приложения
```python
    INTERNAL_IPS = ['127.0.0.1'] #адреса по которым отдается django-debug-toolbar 
   'debug_toolbar',#INSTALLED_APPS
   'debug_toolbar.middleware.DebugToolbarMiddleware',#MIDDLEWARE
```
И подключить в urls 
```python
    urlpatterns.append(
        path('__debug__/', include('debug_toolbar.urls')),
    )
```
Для настройки доступности toolbar из докера контейнера необходимо расширить список адресов получив их автоматически
следующим алгоритмом
```python
if DEBUG:
    import socket
    hostname, _, ips = socket.gethostbyname_ex(socket.gethostname())
    INTERNAL_IPS.append('10.0.2.2')
    INTERNAL_IPS.extend(
        [ip[: ip.rfind('.')] + '.1' for ip in ips]
    )
```

## Логи в GRAFANA и LOKI
Настройка GRAFANA и LOKI в docker-compose 
```yaml
version: '3.9'

services:
  app:
    build:
      dockerfile: ./Dockerfile
    command:
      - 'python'
      - 'manage.py'
      - 'runserver'
      - '0.0.0.0:8080'
    ports:
      - "8000:8080"
  grafana:
    image: grafana/grafana:latest
    environment:
      - GF_AUTH_ANONYMOUS_ENABLE=true #Отключение аутентификации в grafana
      - GF_AUTH_ANONYMOUS_ORG_ROLE=Admin #Установка роли администратора для пользователя
    ports:
      - '3000:3000'
  loki:
    image: grafana/loki:latest
    ports:
      - '3100:3100'
```

